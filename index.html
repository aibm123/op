<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Operation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://rsms.me/inter/inter.css');

        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .task-card {
            cursor: move;
        }
        .kanban-column {
            min-height: 200px;
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-900 p-4">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <div class="flex items-center justify-center mb-6">
                <svg class="w-10 h-10 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2a4 4 0 00-4-4H3a4 4 0 00-4 4v2m11-6V5a4 4 0 00-4-4H6a4 4 0 00-4 4v6m18 4v-2a4 4 0 00-4-4h-2a4 4 0 00-4 4v2m11-6V9a4 4 0 00-4-4h-2a4 4 0 00-4 4v2"></path></svg>
                <h1 class="text-2xl font-bold ml-2 text-gray-800">AI Operation</h1>
            </div>
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-4">Đăng nhập</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-600 mb-2">Email</label>
                    <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" value="" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-600 mb-2">Mật khẩu</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" value="" required>
                </div>
                <div id="login-error" class="text-red-500 text-sm mb-4 text-center h-5"></div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-105 flex items-center justify-center h-10">
                    Đăng nhập
                </button>
            </form>
             <div class="mt-6 text-sm text-gray-600 space-y-4 text-center">
                <div class="text-center">
                    <p class="font-bold text-base text-indigo-600">AI Workstream Intelligence</p>
                    <p class="font-semibold text-gray-700">AI Operation</p>
                </div>
                <div>
                    <h3 class="font-bold mb-2">3 Cấp Tài Khoản Cho App OP:</h3>
                    <ul class="inline-block">
                        <li>Superadmin: superadmin@gmail.com / 123</li>
                        <li>Admin: admin@gmail.com / 123</li>
                        <li>User: user@gmail.com / 123</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold mb-2 text-center">Danh sách Apps mở rộng 5 phòng ban</h3>
                    <table class="w-full text-xs border-collapse border border-gray-300">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="border border-gray-300 p-2 font-semibold text-center">Phòng</th>
                                <th class="border border-gray-300 p-2 font-semibold text-center" colspan="2">Apps</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border border-gray-300 p-2 font-semibold text-center">Manu</td>
                                <td class="border border-gray-300 p-2 text-center"><a href="https://qc.aibm.space" target="_blank" class="text-indigo-600 hover:underline">QC</a></td>
                                <td class="border border-gray-300 p-2 text-center"><a href="https://scm.aibm.space" target="_blank" class="text-indigo-600 hover:underline">SCM</a></td>
                            </tr>
                            <tr>
                                <td class="border border-gray-300 p-2 font-semibold text-center">Acc</td>
                                <td class="border border-gray-300 p-2 text-center"><a href="https://purchase.aibm.space" target="_blank" class="text-indigo-600 hover:underline">Purchase</a></td>
                                <td class="border border-gray-300 p-2 text-center"><a href="https://tax.aibm.space" target="_blank" class="text-indigo-600 hover:underline">Tax</a></td>
                            </tr>
                            <tr>
                                <td class="border border-gray-300 p-2 font-semibold text-center">HR</td>
                                <td class="border border-gray-300 p-2 text-center"><a href="https://train.aibm.space" target="_blank" class="text-indigo-600 hover:underline">Internal</a></td>
                                <td class="border border-gray-300 p-2 text-center"><a href="https://recruit.aibm.space" target="_blank" class="text-indigo-600 hover:underline">Recruit</a></td>
                            </tr>
                            <tr>
                                <td class="border border-gray-300 p-2 font-semibold text-center">BD</td>
                                <td class="border border-gray-300 p-2 text-center"><a href="https://pipe.aibm.space" target="_blank" class="text-indigo-600 hover:underline">Pipeline</a></td>
                                <td class="border border-gray-300 p-2 text-center"><a href="https://funnel.aibm.space" target="_blank" class="text-indigo-600 hover:underline">Funnel</a></td>
                            </tr>
                            <tr>
                                <td class="border border-gray-300 p-2 font-semibold text-center">MKT</td>
                                <td class="border border-gray-300 p-2 text-center"><a href="https://post.aibm.space/" target="_blank" class="text-indigo-600 hover:underline">Content</a></td>
                                <td class="border border-gray-300 p-2 text-center"><a href="https://perform.aibm.space/" target="_blank" class="text-indigo-600 hover:underline">Perform</a></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                 <div>
                    <h3 class="font-bold mb-2">Tài khoản admin & user chung:</h3>
                     <ul class="inline-block">
                        <li>admin@gmail.com / 123</li>
                        <li>user@gmail.com / 123</li>
                    </ul>
                </div>
                 <div>
                    <h3 class="font-bold mb-2">Link database chung & tài khoản:</h3>
                    <p><a href="https://aibm.store/workspace/163" target="_blank" class="text-indigo-600 hover:underline">https://aibm.store/workspace/163</a></p>
                    <p>realtrendasia@gmail.com / aibizmanager</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden h-screen flex relative">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 bg-gray-800 text-white flex flex-col transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="flex items-center justify-center h-20 border-b border-gray-700">
                 <svg class="w-8 h-8 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2a4 4 0 00-4-4H3a4 4 0 00-4 4v2m11-6V5a4 4 0 00-4-4H6a4 4 0 00-4 4v6m18 4v-2a4 4 0 00-4-4h-2a4 4 0 00-4 4v2m11-6V9a4 4 0 00-4-4h-2a4 4 0 00-4 4v2"></path></svg>
                <h1 class="text-2xl font-bold ml-2">AI Operation</h1>
            </div>
            <nav id="main-nav" class="flex-1 px-4 py-4 space-y-2">
                <!-- Nav items will be populated by JS -->
            </nav>
            <div id="user-profile" class="p-4 border-t border-gray-700">
                <!-- User info will be populated by JS -->
            </div>
        </aside>

        <!-- Sidebar Overlay -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="h-20 bg-white shadow-md flex items-center justify-between px-6">
                <!-- Hamburger Menu Button -->
                <button id="menu-toggle-button" class="p-2 -ml-2 rounded-md text-gray-600 md:hidden">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <h2 id="page-title" class="text-2xl font-bold text-gray-700"></h2>
                <button id="logout-button" class="flex items-center text-sm font-medium text-gray-600 hover:text-indigo-600">
                    <i data-lucide="log-out" class="w-5 h-5 mr-2"></i>
                    Đăng xuất
                </button>
            </header>
            <div id="content-area" class="flex-1 p-6 overflow-y-auto bg-gray-100">

                <!-- Chatbot Page -->
                <div id="chatbot-page" class="page h-full">
                    <div class="h-full flex flex-col bg-white rounded-lg shadow-lg">
                        <div id="chat-messages" class="flex-1 p-6 overflow-y-auto">
                            <!-- Chat messages -->
                             <div class="flex items-start mb-4">
                                <div class="w-10 h-10 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold mr-4 shrink-0">AI</div>
                                <div class="bg-gray-200 p-3 rounded-lg max-w-md">
                                    <p class="text-sm">Xin chào! Tôi có thể giúp gì cho bạn hôm nay?</p>
                                </div>
                            </div>
                             <div class="flex items-start justify-end mb-4">
                                <div class="bg-indigo-500 text-white p-3 rounded-lg max-w-md">
                                    <p class="text-sm">Tôi cần thông tin về dự án "Website Redesign".</p>
                                </div>
                                 <div id="current-user-avatar-chat" class="w-10 h-10 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold ml-4 shrink-0"></div>
                            </div>
                        </div>
                        <div class="p-4 border-t">
                            <div class="flex items-center bg-gray-100 rounded-lg">
                                <input type="text" id="chat-input" placeholder="Nhập tin nhắn của bạn..." class="w-full bg-transparent p-3 focus:outline-none">
                                <button id="send-chat-button" class="p-3 text-indigo-500 hover:text-indigo-700">
                                    <i data-lucide="send" class="w-6 h-6"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Class Page -->
                <div id="class-page" class="page">
                    <div class="space-y-6" id="class-content">
                        <!-- Class content will be populated here -->
                    </div>
                </div>

                <!-- Tasklist Page -->
                <div id="tasklist-page" class="page">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- To Do -->
                        <div id="todo-col" class="bg-white rounded-lg shadow-lg">
                            <h3 class="text-lg font-bold p-4 border-b flex items-center justify-between">
                                <span class="flex items-center"><i data-lucide="list" class="w-5 h-5 mr-2 text-red-500"></i>To Do</span>
                                <span id="todo-count" class="bg-red-100 text-red-700 text-sm font-semibold px-2 py-1 rounded-full"></span>
                            </h3>
                            <div id="todo-tasks" class="p-4 space-y-4 kanban-column"></div>
                        </div>
                        <!-- In Progress -->
                        <div id="inprogress-col" class="bg-white rounded-lg shadow-lg">
                            <h3 class="text-lg font-bold p-4 border-b flex items-center justify-between">
                                <span class="flex items-center"><i data-lucide="loader-2" class="w-5 h-5 mr-2 text-yellow-500 animate-spin"></i>In Progress</span>
                                <span id="inprogress-count" class="bg-yellow-100 text-yellow-700 text-sm font-semibold px-2 py-1 rounded-full"></span>
                            </h3>
                            <div id="inprogress-tasks" class="p-4 space-y-4 kanban-column"></div>
                        </div>
                        <!-- Done -->
                        <div id="done-col" class="bg-white rounded-lg shadow-lg">
                             <h3 class="text-lg font-bold p-4 border-b flex items-center justify-between">
                                <span class="flex items-center"><i data-lucide="check-circle-2" class="w-5 h-5 mr-2 text-green-500"></i>Done</span>
                                <span id="done-count" class="bg-green-100 text-green-700 text-sm font-semibold px-2 py-1 rounded-full"></span>
                            </h3>
                            <div id="done-tasks" class="p-4 space-y-4 kanban-column"></div>
                        </div>
                    </div>
                </div>

                <!-- Project Page -->
                <div id="project-page" class="page">
                    <div id="project-list-view">
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6" id="project-folders">
                            <!-- Project folders will be populated here -->
                        </div>
                    </div>
                    <div id="project-detail-view" class="hidden">
                        <!-- Project detail will be populated here -->
                    </div>
                </div>

                <!-- Management Page (Admin/Superadmin) -->
                <div id="management-page" class="page">
                    <div class="bg-white rounded-lg shadow-lg">
                        <div class="border-b border-gray-200">
                            <nav id="management-tabs" class="-mb-px flex space-x-6 px-6" aria-label="Tabs">
                                <!-- Management tabs will be populated here -->
                            </nav>
                        </div>
                        <div class="p-6">
                            <div id="management-content">
                                <!-- Management tab content will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATABASE & API CONFIG ---
            const baserowConfig = {
                host: 'https://aibm.store',
                databaseToken: 'ITGsOdAqUfoPrqKzsxgyCyHS6U6o9Yhk',
                tableIds: {
                    users: '895',
                    projects: '896',
                    tasks: '899',
                    classes: '900',
                    documents: '897',
                    prompts: '901'
                }
            };

            // --- APP STATE ---
            let appState = {
                currentUser: null,
                currentPage: null,
                draggedTask: null,
                createdProjects: [], // For admin project creation flow
                // Live data from Baserow will be stored here
                data: {
                    users: [],
                    projects: [],
                    tasks: [],
                    classes: [],
                    prompts: []
                },
                threadId: null // Add threadId to appState
            };

            // --- DOM ELEMENTS ---
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app');
            const loginForm = document.getElementById('login-form');
            const mainNav = document.getElementById('main-nav');
            const userProfile = document.getElementById('user-profile');
            const pageTitle = document.getElementById('page-title');
            const logoutButton = document.getElementById('logout-button');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const menuToggleButton = document.getElementById('menu-toggle-button');
            
            // --- INITIALIZATION ---
            function init() {
                loginForm.addEventListener('submit', handleLogin);
                logoutButton.addEventListener('click', handleLogout);
                menuToggleButton.addEventListener('click', toggleSidebar);
                sidebarOverlay.addEventListener('click', toggleSidebar);

                document.getElementById('send-chat-button').addEventListener('click', handleSendMessage);
                document.getElementById('chat-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleSendMessage();
                });

                // --- EVENT DELEGATION FOR DYNAMIC CONTENT (DEFINITIVE FIX) ---
                // This single, powerful listener is attached to the whole document body.
                // It will catch clicks on any syllabus or user item, no matter when they are created or re-rendered.
                // This is the correct and final solution.
                document.body.addEventListener('click', (e) => {
                    // For Class Page syllabus items
                    const syllabusHeader = e.target.closest('.syllabus-header');
                    if (syllabusHeader) {
                        e.preventDefault();
                        const assignmentsContainer = syllabusHeader.nextElementSibling;
                        const icon = syllabusHeader.querySelector('.chevron-icon'); // SỬA: Tìm icon bằng class cố định
                        if (assignmentsContainer && icon) {
                            assignmentsContainer.classList.toggle('hidden');
                            icon.classList.toggle('rotate-180');
                        }
                        return;
                    }

                    // For Management > User & Class items
                    const userItemHeader = e.target.closest('.user-item-header');
                    if (userItemHeader) {
                        e.preventDefault();
                        const classListDiv = userItemHeader.nextElementSibling;
                        const icon = userItemHeader.querySelector('.chevron-icon'); // SỬA: Tìm icon bằng class cố định
                        if (classListDiv && icon) {
                            classListDiv.classList.toggle('hidden');
                            icon.classList.toggle('rotate-180');
                        }
                        return;
                    }
                });


                lucide.createIcons();
            }

            function toggleSidebar() {
                sidebar.classList.toggle('-translate-x-full');
                sidebarOverlay.classList.toggle('hidden');
            }
            
            // --- AUTHENTICATION ---
            async function handleLogin(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const errorDiv = document.getElementById('login-error');
                const loginButton = e.target.querySelector('button[type="submit"]');

                errorDiv.textContent = '';
                loginButton.disabled = true;
                loginButton.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Đang xác thực...</span>`;

                const apiUrl = `${baserowConfig.host}/api/database/rows/table/${baserowConfig.tableIds.users}/?user_field_names=true`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: { 'Authorization': `Token ${baserowConfig.databaseToken}` }
                    });

                    if (!response.ok) throw new Error(`API call failed: ${response.status}`);
                    
                    const data = await response.json();
                    const usersFromApi = data.results;

                    // Map raw user data to a consistent format
                    const allUsers = usersFromApi.map(u => ({
                        id: u.id,
                        name: u.name,
                        role: u.role,
                        department: u.depart,
                        avatar: u.name ? u.name.split(' ').map(n => n[0]).join('') : '?',
                        email: u.email,
                        password: u.pass,
                        projects: u.project.map(p => p.id),
                        classes: u.class.map(c => c.id)
                    }));
                    appState.data.users = allUsers;

                    const foundUser = allUsers.find(u => u.email === email && u.password === password);
                    
                    if (foundUser) {
                        appState.currentUser = foundUser;
                        loginButton.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Đang tải dữ liệu...</span>`;
                        await fetchAllAppData(); // Fetch all other data after successful login
                        
                        loginScreen.style.display = 'none';
                        appScreen.classList.remove('hidden');
                        setupUIForUser();
                        navigateTo('chatbot');
                    } else {
                        errorDiv.textContent = 'Email hoặc mật khẩu không đúng.';
                    }

                } catch (error) {
                    console.error('Login Error:', error);
                    errorDiv.textContent = 'Không thể kết nối đến máy chủ xác thực.';
                } finally {
                    loginButton.disabled = false;
                    loginButton.innerHTML = 'Đăng nhập';
                }
            }

            async function fetchAllAppData() {
                const { host, databaseToken, tableIds } = baserowConfig;
                const headers = { 'Authorization': `Token ${databaseToken}` };

                // Helper to fetch and parse a table
                const fetchTable = async (tableId) => {
                    const response = await fetch(`${host}/api/database/rows/table/${tableId}/?user_field_names=true&size=200`, { headers });
                    if (!response.ok) throw new Error(`Failed to fetch table ${tableId}`);
                    const data = await response.json();
                    return data.results;
                };

                try {
                    const [projectsRaw, tasksRaw, classesRaw, promptsRaw] = await Promise.all([
                        fetchTable(tableIds.projects),
                        fetchTable(tableIds.tasks),
                        fetchTable(tableIds.classes),
                        fetchTable(tableIds.prompts)
                    ]);
                    
                    // Map Project Data
                    appState.data.projects = projectsRaw.map(p => ({
                        id: p.id,
                        name: p.Name,
                        docs: p.document.map(d => d.value),
                        // Find all users who are members of this project
                        members: appState.data.users.filter(u => u.projects.includes(p.id)).map(u => u.id)
                    }));

                    // Map Task Data
                    appState.data.tasks = tasksRaw.map(t => {
                        let status = 'todo'; // default status
                        if (t.status === 'On Going') status = 'inprogress';
                        else if (t.status === 'Done') status = 'done';
                        
                        return {
                            id: t.id,
                            title: t.Name,
                            status: status,
                            projectId: t.project.length > 0 ? t.project[0].id : null,
                            assignedTo: t['assign to'].length > 0 ? t['assign to'][0].id : null
                        }
                    }).filter(t => ['todo', 'inprogress', 'done'].includes(t.status)); // Only include tasks for the Kanban board

                    // Map and Group Class Data
                    const groupedClasses = classesRaw.reduce((acc, c) => {
                        const userId = c['assign to'].length > 0 ? c['assign to'][0].id : null;
                        if (!userId) return acc;
                        
                        // Use a composite key to handle cases where a user might be in multiple distinct classes
                        const classKey = `${userId}-${c.Name}`; 

                        if (!acc[classKey]) {
                            acc[classKey] = {
                                id: c.id, // Use the ID of the first entry as the main ID
                                name: c.Name,
                                userId: userId,
                                syllabus: []
                            };
                        }
                        // Each row in Baserow is treated as a syllabus item
                        acc[classKey].syllabus.push({
                            id: `s-${c.id}`,
                            title: c.Syllabus,
                            assignments: [{
                                id: `a-${c.id}`,
                                title: c.Assignments,
                                suggestion: 'Đề xuất từ AI sẽ được cập nhật sau.'
                            }]
                        });
                        return acc;
                    }, {});
                    appState.data.classes = Object.values(groupedClasses);

                    // Map Prompts Data
                    appState.data.prompts = promptsRaw.map(p => ({
                        id: p.id,
                        prompt: p.Prompt,
                        department: p.depart,
                        type: p.type,
                        status: p.status
                    }));

                } catch (error) {
                    console.error("Error fetching app data:", error);
                    document.getElementById('login-error').textContent = 'Lỗi khi tải dữ liệu ứng dụng.';
                    // Optionally, you can log out the user here
                    handleLogout();
                }
            }
            
            function handleLogout() {
                appState.currentUser = null;
                appScreen.classList.add('hidden');
                loginScreen.style.display = 'flex';
                mainNav.innerHTML = '';
                userProfile.innerHTML = '';
                document.getElementById('login-form').reset();
                document.getElementById('login-error').textContent = '';
            }

            // --- UI SETUP & NAVIGATION ---
            function setupUIForUser() {
                mainNav.innerHTML = '';
                const navItems = getNavItemsForRole(appState.currentUser.role);
                navItems.forEach(item => {
                    const navLink = document.createElement('a');
                    navLink.href = '#';
                    navLink.dataset.page = item.id;
                    navLink.className = `flex items-center px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white transition-colors`;
                    navLink.innerHTML = `<i data-lucide="${item.icon}" class="w-5 h-5 mr-3"></i> ${item.name}`;
                    navLink.onclick = (e) => { 
                        e.preventDefault(); 
                        navigateTo(item.id); 
                        // Hide sidebar on mobile after navigation
                        if (window.innerWidth < 768) {
                            toggleSidebar();
                        }
                    };
                    mainNav.appendChild(navLink);
                });

                userProfile.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold mr-3">${appState.currentUser.avatar}</div>
                        <div>
                            <p class="font-semibold">${appState.currentUser.name}</p>
                            <p class="text-sm text-gray-400">${appState.currentUser.role}</p>
                        </div>
                    </div>`;
                document.getElementById('current-user-avatar-chat').innerText = appState.currentUser.avatar;
                lucide.createIcons();
            }
            
            function getNavItemsForRole(role) {
                const allNavs = [
                    { id: 'chatbot', name: 'Chatbot', icon: 'message-circle' },
                    { id: 'tasklist', name: 'Task List', icon: 'list-checks' },
                    { id: 'project', name: 'Project', icon: 'folder-git-2' },
                    { id: 'class', name: 'Class', icon: 'school' },
                    { id: 'management', name: 'Quản lý', icon: 'sliders-horizontal' }
                ];
                if (role === 'user') {
                    return allNavs.filter(nav => nav.id !== 'management');
                }
                return allNavs;
            }

            function navigateTo(pageId) {
                appState.currentPage = pageId;

                // Create a unique threadId for the user's chat session if it doesn't exist
                if (pageId === 'chatbot' && !appState.threadId) {
                    appState.threadId = `thread_${appState.currentUser.id}_${Date.now()}`;
                }

                document.querySelectorAll('#main-nav a').forEach(link => {
                    link.classList.toggle('bg-gray-900', link.dataset.page === pageId);
                    link.classList.toggle('text-white', link.dataset.page === pageId);
                });

                document.querySelectorAll('.page').forEach(page => {
                    page.classList.toggle('active', page.id === `${pageId}-page`);
                });
                
                const navItem = getNavItemsForRole(appState.currentUser.role).find(item => item.id === pageId);
                pageTitle.textContent = navItem ? navItem.name : 'Dashboard';

                renderPageContent(pageId);
            }
            
            function renderPageContent(pageId) {
                switch(pageId) {
                    case 'class': renderClass(); break;
                    case 'tasklist': renderTaskList(); break;
                    case 'project': renderProjectList(); break;
                    case 'management': renderManagementPage(); break;
                }
            }
            
            // --- PAGE RENDERING FUNCTIONS ---
            async function handleSendMessage() {
                const chatInput = document.getElementById('chat-input');
                const message = chatInput.value.trim();
                if (!message) return;

                const chatMessages = document.getElementById('chat-messages');
                const sendButton = document.getElementById('send-chat-button');

                // 1. Display user's message immediately
                chatMessages.innerHTML += `
                     <div class="flex items-start justify-end mb-4">
                        <div class="bg-indigo-500 text-white p-3 rounded-lg max-w-md">
                            <p class="text-sm">${message}</p>
                        </div>
                         <div class="w-10 h-10 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold ml-4 shrink-0">${appState.currentUser.avatar}</div>
                    </div>`;
                chatInput.value = '';
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // 2. Show typing indicator and disable input
                sendButton.disabled = true;
                chatInput.disabled = true;
                const typingIndicator = document.createElement('div');
                typingIndicator.id = 'typing-indicator';
                typingIndicator.className = 'flex items-start mb-4';
                typingIndicator.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold mr-4 shrink-0">AI</div>
                    <div class="bg-gray-200 p-3 rounded-lg">
                        <div class="flex items-center space-x-1">
                            <span class="h-2 w-2 bg-gray-500 rounded-full animate-bounce [animation-delay:-0.3s]"></span>
                            <span class="h-2 w-2 bg-gray-500 rounded-full animate-bounce [animation-delay:-0.15s]"></span>
                            <span class="h-2 w-2 bg-gray-500 rounded-full animate-bounce"></span>
                        </div>
                    </div>
                `;
                chatMessages.appendChild(typingIndicator);
                chatMessages.scrollTop = chatMessages.scrollHeight;


                // 3. Call the webhook
                const webhookUrl = 'https://aps.aibm.space/webhook/corp0';
                const payload = {
                    task: 'chatbot',
                    prompt: message,
                    email: appState.currentUser.email,
                    threadid: appState.threadId,
                    depart: appState.currentUser.department
                };

                try {
                    const response = await fetch(webhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`Webhook response was not ok: ${response.statusText}`);
                    }

                    const responseData = await response.json();
                    const botReply = responseData[0]?.output || "Tôi không nhận được phản hồi hợp lệ.";

                    // 4. Display bot's response
                     typingIndicator.innerHTML = `
                        <div class="w-10 h-10 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold mr-4 shrink-0">AI</div>
                        <div class="bg-gray-200 p-3 rounded-lg max-w-md">
                            <p class="text-sm">${botReply}</p>
                        </div>`;

                } catch (error) {
                    console.error('Error calling webhook:', error);
                    typingIndicator.innerHTML = `
                        <div class="w-10 h-10 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold mr-4 shrink-0">AI</div>
                        <div class="bg-red-100 border border-red-400 text-red-700 p-3 rounded-lg max-w-md">
                            <p class="text-sm">Đã có lỗi xảy ra. Vui lòng thử lại.</p>
                        </div>`;
                } finally {
                    // 5. Re-enable input
                    sendButton.disabled = false;
                    chatInput.disabled = false;
                    chatInput.focus();
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }

            function renderClass() {
                let userClasses;
                const { role, id, department } = appState.currentUser;
                const { users, classes } = appState.data;

                if (role === 'superadmin') {
                    userClasses = classes;
                } else if (role === 'admin') {
                    const departmentUserIds = users.filter(u => u.department === department).map(u => u.id);
                    userClasses = classes.filter(c => departmentUserIds.includes(c.userId));
                } else { // user
                    userClasses = classes.filter(c => c.userId === id);
                }

                const classContent = document.getElementById('class-content');
                classContent.innerHTML = '';

                if (userClasses.length === 0) {
                    classContent.innerHTML = '<div class="bg-white p-6 rounded-lg shadow-lg"><p class="text-gray-500">Không có lớp học nào.</p></div>';
                    return;
                }
                
                const classesByUser = userClasses.reduce((acc, c) => {
                    const user = users.find(u => u.id === c.userId);
                    if (!user) return acc;
                    if (!acc[c.userId]) {
                        acc[c.userId] = { user, classes: [] };
                    }
                    acc[c.userId].classes.push(c);
                    return acc;
                }, {});

                for (const userId in classesByUser) {
                    const userData = classesByUser[userId];
                    const user = userData.user;
                    
                    const userClassContainer = document.createElement('div');
                    if (role !== 'user') {
                         userClassContainer.innerHTML = `<h3 class="text-lg font-bold mb-2 text-gray-600">Lớp học của ${user.name}</h3>`;
                    }
                    
                    userData.classes.forEach(c => {
                        const classElement = document.createElement('div');
                        classElement.className = 'bg-white p-6 rounded-lg shadow-lg mb-4';
                        classElement.innerHTML = `<h4 class="text-xl font-bold mb-4">${c.name}</h4><div class="space-y-3">${
                            c.syllabus.map(s => `
                                <div class="syllabus-item border rounded-md">
                                    <div class="syllabus-header flex items-center justify-between p-3 cursor-pointer hover:bg-gray-50">
                                        <span class="font-semibold flex items-center"><i data-lucide="book-open" class="w-5 h-5 mr-2 text-indigo-500"></i>${s.title}</span>
                                        <i data-lucide="chevron-down" class="w-5 h-5 transition-transform chevron-icon"></i>
                                    </div>
                                    <div class="assignments-container hidden p-4 border-t bg-gray-50 space-y-4">
                                        ${s.assignments.map(a => `
                                            <div class="assignment-item">
                                                <p class="flex items-center"><i data-lucide="clipboard-list" class="w-5 h-5 mr-2 text-green-500"></i>${a.title}</p>
                                                <div class="mt-2 ml-7 p-3 bg-indigo-50 border border-indigo-200 rounded-md">
                                                    <p class="text-xs font-semibold text-indigo-700 mb-1">AI Đề xuất:</p>
                                                    <p class="text-sm text-indigo-800">${a.suggestion}</p>
                                                </div>
                                            </div>
                                        `).join('') || '<p class="text-sm text-gray-500">Không có bài tập cho đề cương này.</p>'}
                                    </div>
                                </div>
                            `).join('')}</div>`;
                        userClassContainer.appendChild(classElement);
                    });
                    classContent.appendChild(userClassContainer);
                }

                // Old, broken click handling removed from here.

                lucide.createIcons();
            }
            
            function renderTaskList() {
                let tasksToDisplay;
                const { role, id, department } = appState.currentUser;
                const { users, tasks } = appState.data;

                if (role === 'superadmin') {
                    tasksToDisplay = tasks;
                } else if (role === 'admin') {
                    const departmentUserIds = users.filter(u => u.department === department).map(u => u.id);
                    tasksToDisplay = tasks.filter(t => departmentUserIds.includes(t.assignedTo));
                } else { // user
                    tasksToDisplay = tasks.filter(t => t.assignedTo === id);
                }

                ['todo', 'inprogress', 'done'].forEach(status => {
                    const container = document.getElementById(`${status}-tasks`);
                    container.innerHTML = '';
                    const tasksInStatus = tasksToDisplay.filter(t => t.status === status);
                    tasksInStatus.forEach(task => {
                        const project = appState.data.projects.find(p => p.id === task.projectId);
                        const assignedUser = users.find(u => u.id === task.assignedTo);
                        container.innerHTML += `
                            <div id="task-${task.id}" class="task-card bg-gray-50 p-3 rounded-lg border shadow-sm" draggable="true">
                                <p class="font-semibold mb-1">${task.title}</p>
                                <p class="text-sm text-gray-500">${project ? project.name : 'No Project'}</p>
                                ${role !== 'user' && assignedUser ? `<div class="text-xs text-right mt-1 font-medium text-indigo-600">${assignedUser.name}</div>` : ''}
                            </div>`;
                    });
                    document.getElementById(`${status}-count`).textContent = tasksInStatus.length;
                });
                addDragAndDropListeners();
            }
            
            function renderProjectList() {
                let projectsToDisplay;
                const { role, id, department } = appState.currentUser;
                const { users, projects } = appState.data;

                if (role === 'superadmin') {
                    projectsToDisplay = projects;
                } else if (role === 'admin') {
                    const departmentUserIds = users.filter(u => u.department === department).map(u => u.id);
                    projectsToDisplay = projects.filter(p => p.members.some(memberId => departmentUserIds.includes(memberId)));
                } else { // user
                    projectsToDisplay = projects.filter(p => p.members.includes(id));
                }
                
                const projectListView = document.getElementById('project-list-view');
                projectListView.classList.remove('hidden');
                document.getElementById('project-detail-view').classList.add('hidden');

                const projectFolders = document.getElementById('project-folders');
                projectFolders.innerHTML = '';

                projectsToDisplay.forEach(project => {
                    const folder = document.createElement('div');
                    folder.className = 'flex flex-col items-center justify-center p-4 bg-white rounded-lg shadow-lg text-center cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all';
                    folder.innerHTML = `<i data-lucide="folder" class="w-16 h-16 text-yellow-500"></i><span class="mt-2 font-semibold text-gray-700">${project.name}</span>`;
                    folder.onclick = () => renderProjectDetail(project.id);
                    projectFolders.appendChild(folder);
                });
                lucide.createIcons();
            }
            
            function renderProjectDetail(projectId) {
                document.getElementById('project-list-view').classList.add('hidden');
                const detailView = document.getElementById('project-detail-view');
                detailView.classList.remove('hidden');

                const project = appState.data.projects.find(p => p.id === projectId);
                const projectTasks = appState.data.tasks.filter(t => t.projectId === projectId);
                
                detailView.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="flex items-center mb-6">
                            <button id="back-to-projects" class="mr-4 p-2 rounded-full hover:bg-gray-200"><i data-lucide="arrow-left"></i></button>
                            <h3 class="text-2xl font-bold">${project.name}</h3>
                        </div>
                        
                        <div class="border-b">
                            <nav class="flex space-x-4" id="project-detail-tabs">
                                <a href="#" data-tab="tasks" class="px-3 py-2 font-medium text-sm rounded-t-md border-b-2 border-indigo-500 text-indigo-600">Danh sách Task</a>
                                <a href="#" data-tab="docs" class="px-3 py-2 font-medium text-sm rounded-t-md border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Tài liệu</a>
                            </nav>
                        </div>

                        <div id="project-tasks-content" class="mt-4">
                            ${projectTasks.map(task => {
                                const assignedUser = appState.data.users.find(u => u.id === task.assignedTo);
                                return `
                                <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-md">
                                    <div>
                                        <p>${task.title}</p>
                                        <p class="text-xs text-gray-500">Giao cho: ${assignedUser ? assignedUser.name : 'N/A'}</p>
                                    </div>
                                    <span class="text-xs font-semibold px-2 py-1 rounded-full ${task.status === 'done' ? 'bg-green-100 text-green-800' : task.status === 'inprogress' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                        ${task.status}
                                    </span>
                                </div>`
                            }).join('') || '<p class="text-gray-500 mt-4">Không có task nào.</p>'}
                        </div>
                        <div id="project-docs-content" class="hidden mt-4">
                            ${project.docs.map(doc => `
                                <div class="flex items-center p-3 hover:bg-gray-50 rounded-md">
                                    <i data-lucide="file-text" class="w-5 h-5 mr-3 text-gray-500"></i>
                                    <p>${doc}</p>
                                </div>
                            `).join('') || '<p class="text-gray-500 mt-4">Không có tài liệu nào.</p>'}
                        </div>
                    </div>
                `;

                document.getElementById('back-to-projects').onclick = renderProjectList;
                
                const tabs = document.querySelectorAll('#project-detail-tabs a');
                tabs.forEach(tab => {
                    tab.addEventListener('click', e => {
                        e.preventDefault();
                        tabs.forEach(t => {
                            t.classList.remove('border-indigo-500', 'text-indigo-600');
                            t.classList.add('border-transparent', 'text-gray-500');
                        });
                        tab.classList.add('border-indigo-500', 'text-indigo-600');
                        
                        document.getElementById('project-tasks-content').classList.toggle('hidden', tab.dataset.tab !== 'tasks');
                        document.getElementById('project-docs-content').classList.toggle('hidden', tab.dataset.tab !== 'docs');
                    });
                });
                
                lucide.createIcons();
            }

            function renderManagementPage() {
                const tabsContainer = document.getElementById('management-tabs');
                tabsContainer.innerHTML = `
                    <a href="#" data-tab="dashboard" class="management-tab px-3 py-3 font-medium text-sm border-b-2 border-indigo-500 text-indigo-600">Dashboard</a>
                    <a href="#" data-tab="projects" class="management-tab px-3 py-3 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Project</a>
                    <a href="#" data-tab="users" class="management-tab px-3 py-3 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">User & Class</a>`;
                
                document.querySelectorAll('.management-tab').forEach(tab => {
                    tab.addEventListener('click', e => {
                        e.preventDefault();
                        document.querySelectorAll('.management-tab').forEach(t => t.classList.remove('border-indigo-500', 'text-indigo-600'));
                        tab.classList.add('border-indigo-500', 'text-indigo-600');
                        renderManagementTabContent(tab.dataset.tab);
                    });
                });
                renderManagementTabContent('dashboard');
            }

            function renderManagementTabContent(tabId, subView = null, data = null) {
                const contentContainer = document.getElementById('management-content');
                
                if (tabId === 'dashboard') {
                    contentContainer.innerHTML = `
                        <h4 class="text-lg font-bold mb-4">Số liệu tổng</h4>
                         <div class="grid grid-cols-2 gap-4 mb-8">
                            <div class="bg-gray-100 p-4 rounded-lg"><p class="font-bold text-2xl">${appState.data.projects.length}</p><p class="text-gray-600">Tổng dự án</p></div>
                             <div class="bg-gray-100 p-4 rounded-lg"><p class="font-bold text-2xl">${appState.data.users.length}</p><p class="text-gray-600">Tổng người dùng</p></div>
                        </div>
                        <h4 class="text-lg font-bold mb-4">Danh sách đề xuất</h4>
                        <div class="space-y-4">
                             ${appState.data.prompts.filter(p => p.status === 'đang đợi').map(p => `
                                <div class="p-4 border rounded-lg flex items-center justify-between">
                                    <div>
                                        <p class="font-semibold">${p.type}: ${p.department}</p>
                                        <p class="text-sm text-gray-600">"${p.prompt}"</p>
                                    </div>
                                    <div class="flex-shrink-0 flex space-x-2"><button class="px-3 py-1 text-xs font-semibold text-white bg-green-500 rounded-full hover:bg-green-600">Duyệt</button><button class="px-3 py-1 text-xs font-semibold text-white bg-red-500 rounded-full hover:bg-red-600">Từ chối</button></div>
                                </div>
                            `).join('') || '<p class="text-gray-500">Không có đề xuất nào đang chờ.</p>'}
                        </div>`;
                } else if (tabId === 'projects') {
                    if (subView === 'suggest_tasks') {
                        let pendingTasks = ['Phân tích yêu cầu & lên kế hoạch', 'Thiết kế UI/UX', 'Phát triển Frontend', 'Phát triển Backend', 'Kiểm thử (Testing)', 'Triển khai (Deployment)']
                            .map(title => ({ title, status: 'pending' })); // pending, approved, rejected

                        contentContainer.innerHTML = `
                            <h4 class="text-lg font-bold mb-4">Duyệt Task cho Project: ${data.projectName}</h4>
                            <div class="space-y-3 mb-4">
                            ${pendingTasks.map((task, index) => `
                                <div class="suggested-task-card flex items-center justify-between p-3 border rounded-lg bg-white">
                                    <p>${task.title}</p>
                                    <div class="task-actions flex space-x-2" data-task-index="${index}">
                                        <button class="approve-task-btn px-3 py-1 text-xs font-semibold text-white bg-green-500 rounded-full hover:bg-green-600">Duyệt</button>
                                        <button class="reject-task-btn px-3 py-1 text-xs font-semibold text-white bg-red-500 rounded-full hover:bg-red-600">Từ chối</button>
                                    </div>
                                </div>`).join('')}
                            </div>
                            <div class="flex space-x-3">
                                <button id="save-project-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Lưu Project</button>
                                <button id="cancel-project-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Hủy</button>
                            </div>
                        `;
                        document.querySelectorAll('.task-actions').forEach(actions => {
                            actions.querySelector('.approve-task-btn').onclick = () => {
                                const index = actions.dataset.taskIndex;
                                pendingTasks[index].status = 'approved';
                                actions.parentElement.classList.remove('bg-red-50');
                                actions.parentElement.classList.add('bg-green-50');
                                actions.innerHTML = '<span class="text-sm font-semibold text-green-700">Đã duyệt</span>';
                            };
                            actions.querySelector('.reject-task-btn').onclick = () => {
                                const index = actions.dataset.taskIndex;
                                pendingTasks[index].status = 'rejected';
                                actions.parentElement.classList.remove('bg-green-50');
                                actions.parentElement.classList.add('bg-red-50');
                                actions.innerHTML = '<span class="text-sm font-semibold text-red-700">Đã từ chối</span>';
                            };
                        });

                        document.getElementById('save-project-btn').onclick = () => {
                            appState.createdProjects.push({id: Date.now(), name: data.projectName, tasks: pendingTasks });
                            renderManagementTabContent('projects');
                        };
                        document.getElementById('cancel-project-btn').onclick = () => renderManagementTabContent('projects');

                    } else if (subView === 'view_project') {
                        const project = appState.createdProjects.find(p => p.id === data.projectId);
                        contentContainer.innerHTML = `
                            <div class="flex items-center mb-4">
                                <button id="back-to-mng-projects" class="mr-4 p-2 rounded-full hover:bg-gray-200"><i data-lucide="arrow-left"></i></button>
                                <h4 class="text-lg font-bold">Tasks cho Project: ${project.name}</h4>
                            </div>
                            <div class="space-y-2" id="project-task-list-container">
                            ${project.tasks.map((task, index) => {
                                const statusClass = task.status === 'approved' ? 'bg-green-50' : task.status === 'rejected' ? 'bg-red-50' : 'bg-white';
                                return `<div class="project-task-item flex justify-between items-center p-3 rounded-md border ${statusClass}" data-task-index="${index}">
                                    <span>${task.title}</span>
                                    <div class="task-actions flex space-x-2">
                                        <button class="approve-task-btn px-3 py-1 text-xs font-semibold text-white bg-green-500 rounded-full hover:bg-green-600">Duyệt</button>
                                        <button class="reject-task-btn px-3 py-1 text-xs font-semibold text-white bg-red-500 rounded-full hover:bg-red-600">Từ chối</button>
                                    </div>
                                </div>`;
                            }).join('') || '<p>Không có task nào.</p>'}
                            </div>
                        `;
                        document.getElementById('back-to-mng-projects').onclick = () => renderManagementTabContent('projects');

                        document.getElementById('project-task-list-container').addEventListener('click', e => {
                            const approveBtn = e.target.closest('.approve-task-btn');
                            const rejectBtn = e.target.closest('.reject-task-btn');

                            if (!approveBtn && !rejectBtn) return;
                            
                            const taskItem = e.target.closest('.project-task-item');
                            const taskIndex = parseInt(taskItem.dataset.taskIndex);

                            if (approveBtn) {
                                project.tasks[taskIndex].status = 'approved';
                                taskItem.className = 'project-task-item flex justify-between items-center p-3 rounded-md border bg-green-50';
                            } else if (rejectBtn) {
                                project.tasks[taskIndex].status = 'rejected';
                                taskItem.className = 'project-task-item flex justify-between items-center p-3 rounded-md border bg-red-50';
                            }
                        });

                        lucide.createIcons();
                    } else {
                         contentContainer.innerHTML = `
                            <h4 class="text-lg font-bold mb-4">Tạo project mới</h4>
                            <form id="create-project-form" class="space-y-3 mb-6 p-4 border rounded-lg bg-gray-50">
                                <input type="text" id="project-name-input" placeholder="Tên project" class="w-full px-3 py-2 border rounded-md" required>
                                <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Tạo & Duyệt Task</button>
                            </form>
                             <h4 class="text-lg font-bold mb-4">Danh sách project đã tạo</h4>
                             <div class="space-y-2">
                                ${appState.createdProjects.map(p => `
                                    <div class="flex items-center p-3 cursor-pointer hover:bg-gray-100 rounded-md border" data-project-id="${p.id}">
                                        <i data-lucide="folder-check" class="w-5 h-5 mr-3 text-green-600"></i>
                                        <span>${p.name}</span>
                                    </div>
                                `).join('') || '<p class="text-gray-500">Chưa có project nào được tạo.</p>'}
                             </div>
                        `;
                        document.getElementById('create-project-form').addEventListener('submit', e => {
                            e.preventDefault();
                            const projectName = document.getElementById('project-name-input').value;
                            if (projectName) renderManagementTabContent('projects', 'suggest_tasks', { projectName });
                        });
                        document.querySelectorAll('[data-project-id]').forEach(item => {
                            item.onclick = () => {
                                const projectId = parseInt(item.dataset.projectId);
                                renderManagementTabContent('projects', 'view_project', { projectId });
                            };
                        });
                         lucide.createIcons();
                    }

                } else if (tabId === 'users') {
                    let usersToDisplay = appState.currentUser.role === 'superadmin' 
                        ? appState.data.users 
                        : appState.data.users.filter(u => u.department === appState.currentUser.department);
                    
                    contentContainer.innerHTML = `<h4 class="text-lg font-bold mb-4">Danh sách User</h4><div id="user-list-management" class="space-y-2">
                        ${usersToDisplay.map(user => `
                             <div class="user-item border rounded-lg">
                                <div class="user-item-header flex items-center justify-between p-3 cursor-pointer hover:bg-gray-50">
                                    <div class="flex items-center">
                                         <div class="w-8 h-8 rounded-full bg-gray-300 text-gray-700 flex items-center justify-center font-bold mr-3">${user.avatar}</div>
                                         <div><p class="font-semibold">${user.name}</p><p class="text-sm text-gray-500">${user.department} - ${user.role}</p></div>
                                    </div><i data-lucide="chevron-down" class="w-5 h-5 transition-transform chevron-icon"></i>
                                </div>
                                <div class="user-classes-list hidden p-4 border-t bg-gray-50">
                                    <h5 class="font-semibold mb-2">Danh sách lớp học:</h5>
                                    ${appState.data.classes.filter(c => c.userId === user.id).map(c => `<p class="text-sm pl-2">- ${c.name}</p>`).join('') || '<p class="text-sm text-gray-500 pl-2">Chưa tham gia lớp nào.</p>'}
                                </div></div>`).join('')}</div>`;

                    // Old, broken click handling removed from here.

                     lucide.createIcons();
                }
            }
            
            // --- KANBAN DRAG & DROP ---
            function addDragAndDropListeners() {
                const tasks = document.querySelectorAll('.task-card');
                const columns = document.querySelectorAll('.kanban-column');

                tasks.forEach(task => {
                    task.addEventListener('dragstart', () => { appState.draggedTask = task; setTimeout(() => task.classList.add('opacity-50'), 0); });
                    task.addEventListener('dragend', () => {
                        if (!appState.draggedTask) return;
                        appState.draggedTask.classList.remove('opacity-50');
                        const taskId = parseInt(appState.draggedTask.id.replace('task-', ''));
                        const newStatus = appState.draggedTask.parentElement.id.replace('-tasks', '');
                        const taskToUpdate = appState.data.tasks.find(t => t.id === taskId);
                        if (taskToUpdate) taskToUpdate.status = newStatus;
                        appState.draggedTask = null;
                        renderTaskList(); // Re-render counts
                    });
                });

                columns.forEach(column => {
                    column.addEventListener('dragover', e => { e.preventDefault(); if (!appState.draggedTask) return; const afterElement = getDragAfterElement(column, e.clientY); if (afterElement == null) { column.appendChild(appState.draggedTask); } else { column.insertBefore(appState.draggedTask, afterElement); } });
                });
            }

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.task-card:not(.opacity-50)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            // --- START THE APP ---
            init();
        });
    </script>
</body>
</html>




